name: Turbo

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # Change detection to optimize CI pipeline
  change-detection:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:5d15ec5
      options: --user root
    outputs:
      web-changed: ${{ steps.changes.outputs.web }}
      docs-changed: ${{ steps.changes.outputs.docs }}
      any-app-changed: ${{ steps.changes.outputs.any-app }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for PR change detection

      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Detect changes
        id: changes
        run: |
          echo "Detecting changes..."

          # For push to main, assume everything changed
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "Push to main branch - assuming all apps changed"
            echo "web=true" >> $GITHUB_OUTPUT
            echo "docs=true" >> $GITHUB_OUTPUT
            echo "any-app=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For PRs, detect actual changes
          echo "Checking PR changes..."
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # Check web app changes
          if git diff --quiet $BASE_SHA...$HEAD_SHA -- turbo/apps/web/ turbo/packages/; then
            echo "No changes in web app"
            WEB_CHANGED="false"
          else
            echo "Changes detected in web app"
            WEB_CHANGED="true"
          fi

          # Check docs app changes
          if git diff --quiet $BASE_SHA...$HEAD_SHA -- turbo/apps/docs/ turbo/packages/; then
            echo "No changes in docs app"
            DOCS_CHANGED="false"
          else
            echo "Changes detected in docs app"
            DOCS_CHANGED="true"
          fi

          # Check root config changes (affects all apps)
          if ! git diff --quiet $BASE_SHA...$HEAD_SHA -- turbo/package.json turbo/pnpm-lock.yaml turbo/turbo.json; then
            echo "Root config changes detected"
            WEB_CHANGED="true"
            DOCS_CHANGED="true"
          fi

          # Set outputs
          echo "web=$WEB_CHANGED" >> $GITHUB_OUTPUT
          echo "docs=$DOCS_CHANGED" >> $GITHUB_OUTPUT

          # Any app changed?
          if [ "$WEB_CHANGED" == "true" ] || [ "$DOCS_CHANGED" == "true" ]; then
            echo "any-app=true" >> $GITHUB_OUTPUT
          else
            echo "any-app=false" >> $GITHUB_OUTPUT
          fi

          # Summary
          echo "=== Change Detection Summary ==="
          echo "Web app changed: $WEB_CHANGED"
          echo "Docs app changed: $DOCS_CHANGED"
          echo "================================"

  lint:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:5d15ec5
      options: --user root
    needs: [change-detection]
    if: needs.change-detection.outputs.any-app-changed == 'true' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install dependencies
        working-directory: turbo
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: lefthook run pre-commit --all-files --force

  test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:5d15ec5
      options: --user root
    needs: [change-detection]
    if: needs.change-detection.outputs.any-app-changed == 'true' || github.event_name == 'push'
    services:
      postgres:
        image: postgres:17-alpine
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        env:
          POSTGRES_HOST_AUTH_METHOD: trust

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install dependencies
        working-directory: turbo
        run: pnpm install --frozen-lockfile

      - name: Test
        working-directory: turbo
        env:
          DATABASE_URL: postgresql://postgres@postgres:5432/postgres
        run: pnpm test

  build-web:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:5d15ec5
      options: --user root
    needs: [change-detection, test]
    if: needs.change-detection.outputs.web-changed == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install dependencies
        working-directory: turbo
        run: pnpm install --frozen-lockfile

      - name: Setup build cache
        uses: actions/cache@v3
        with:
          path: |
            turbo/.turbo
            turbo/**/.next/cache
          key: ${{ runner.os }}-build-web-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-web-

      - name: Build Web Application
        uses: ./.github/actions/vercel-build
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ vars.VERCEL_TEAM_ID }}
          vercel-project-id: ${{ vars.VERCEL_PROJECT_ID_WEB }}
          artifact-name: turbo-build-${{ github.sha }}-web

  build-docs:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:5d15ec5
      options: --user root
    needs: [change-detection, test]
    if: needs.change-detection.outputs.docs-changed == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install dependencies
        working-directory: turbo
        run: pnpm install --frozen-lockfile

      - name: Setup build cache
        uses: actions/cache@v3
        with:
          path: |
            turbo/.turbo
            turbo/**/.next/cache
          key: ${{ runner.os }}-build-docs-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-build-docs-

      - name: Build Docs Application
        uses: ./.github/actions/vercel-build
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ vars.VERCEL_TEAM_ID }}
          vercel-project-id: ${{ vars.VERCEL_PROJECT_ID_DOCS }}
          artifact-name: turbo-build-${{ github.sha }}-docs

  # Database for preview environment
  database:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:5d15ec5
      options: --user root
    needs: [change-detection, test, lint]
    if: github.event_name == 'pull_request' && needs.change-detection.outputs.web-changed == 'true'
    permissions:
      deployments: write
    outputs:
      database-url: ${{ steps.branch.outputs.database-url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install dependencies
        working-directory: turbo
        run: pnpm install --frozen-lockfile

      - name: Create Neon Branch and Run Migrations
        id: branch
        uses: ./.github/actions/neon-branch
        with:
          neon-api-key: ${{ secrets.NEON_API_KEY }}
          neon-project-id: ${{ vars.NEON_PROJECT_ID }}
          branch-name: "${{ github.head_ref }}"
          action: "create"

  # Deploy web application
  deploy-web:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:5d15ec5
      options: --user root
    needs: [build-web, database, lint]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.build-web.result == 'success' &&
      needs.database.result == 'success'
    permissions:
      pull-requests: write
      deployments: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install dependencies
        working-directory: turbo
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: turbo-build-${{ github.sha }}-web

      - name: Deploy Web to Vercel
        id: deploy
        uses: ./.github/actions/vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ vars.VERCEL_TEAM_ID }}
          vercel-project-id: ${{ vars.VERCEL_PROJECT_ID_WEB }}
          environment: preview
          deployment-env: web
          environment-variables: |
            DATABASE_URL=${{ needs.database.outputs.database-url }}
          meta-branch: ${{ github.head_ref }}
          meta-pr: ${{ github.event.pull_request.number }}

  # Deploy docs application
  deploy-docs:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vm0-ai/vm0-toolchain:5d15ec5
      options: --user root
    needs: [build-docs, lint]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.build-docs.result == 'success' &&
      vars.VERCEL_PROJECT_ID_DOCS != ''
    permissions:
      pull-requests: write
      deployments: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configure git safe directory
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Install dependencies
        working-directory: turbo
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: turbo-build-${{ github.sha }}-docs

      - name: Deploy Docs to Vercel
        id: deploy
        uses: ./.github/actions/vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ vars.VERCEL_TEAM_ID }}
          vercel-project-id: ${{ vars.VERCEL_PROJECT_ID_DOCS }}
          environment: preview
          deployment-env: docs
          meta-branch: ${{ github.head_ref }}
          meta-pr: ${{ github.event.pull_request.number }}