# VM0 Web - Multi-stage Docker Build
# Build context: repository root (see docker-compose.dev.yml)

FROM node:20.20.0-alpine AS base
RUN corepack enable && corepack prepare pnpm@10.15.0 --activate
RUN apk add --no-cache openssl

# ============ Dependencies ============
FROM base AS deps
WORKDIR /app

# All workspace package.json files must be present for pnpm to resolve the graph.
COPY turbo/pnpm-lock.yaml turbo/pnpm-workspace.yaml turbo/package.json turbo/.npmrc ./
COPY turbo/apps/web/package.json apps/web/package.json
COPY turbo/apps/cli/package.json apps/cli/package.json
COPY turbo/apps/docs/package.json apps/docs/package.json
COPY turbo/apps/platform/package.json apps/platform/package.json
COPY turbo/apps/runner/package.json apps/runner/package.json
COPY turbo/packages/core/package.json packages/core/package.json
COPY turbo/packages/ui/package.json packages/ui/package.json
COPY turbo/packages/eslint-config/package.json packages/eslint-config/package.json
COPY turbo/packages/typescript-config/package.json packages/typescript-config/package.json
COPY turbo/packages/proxy/package.json packages/proxy/package.json
COPY turbo/packages/sandbox-scripts/package.json packages/sandbox-scripts/package.json

RUN pnpm install --frozen-lockfile --ignore-scripts \
    && pnpm rebuild esbuild

# ============ Build ============
FROM deps AS builder

COPY turbo/turbo.json .
COPY turbo/packages/ ./packages
COPY turbo/apps/web ./apps/web

# Inject standalone output mode without modifying source
RUN sed -i 's/const nextConfig = {/const nextConfig = {\n  output: "standalone",/' apps/web/next.config.js

ENV SKIP_ENV_VALIDATION=true
ENV NEXT_TELEMETRY_DISABLED=1
ENV NEXT_PUBLIC_BASE_URL=http://localhost
ENV SELF_HOSTED=true

# Point Strapi to the build-time mock server (see below)
ENV NEXT_PUBLIC_STRAPI_URL=http://localhost:1337

# Run a minimal mock server during build so blog pages that fetch from
# Strapi get valid empty responses instead of ECONNREFUSED.
# The mock server runs as the main process and the build runs as a child,
# ensuring the server stays alive for the entire duration (especially
# important under QEMU emulation where arm64 builds can take 10+ minutes).
RUN set -e; \
    node -e " \
      const http = require('http'); \
      const { spawn } = require('child_process'); \
      const srv = http.createServer((_, r) => { \
        r.writeHead(200, {'Content-Type':'application/json'}); \
        r.end(JSON.stringify({data:[],meta:{}})); \
      }); \
      srv.listen(1337, () => { \
        const child = spawn('pnpm', ['run', 'build', '--filter=web'], { \
          stdio: 'inherit', \
          shell: true \
        }); \
        child.on('close', (code) => { \
          srv.close(); \
          process.exit(code || 0); \
        }); \
      }); \
    "

# ============ Runtime ============
FROM node:20.20.0-alpine AS runner
WORKDIR /app

RUN apk add --no-cache openssl curl su-exec

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# Non-root user for security (created before COPY so --chown can reference it)
# --ingroup nodejs: required so nextjs can access the Docker socket (GID 1001)
RUN addgroup --system --gid 1001 nodejs \
    && adduser --system --uid 1001 --ingroup nodejs nextjs \
    && mkdir -p /app/data && chown nextjs:nodejs /app/data

# Migration script runtime dependencies
# tsx is a CLI tool -> install globally
# drizzle-orm, postgres, drizzle-kit are imported by migrate.ts -> install locally
RUN npm install -g tsx \
    && cd /app && npm install --no-save drizzle-orm@0.44.5 postgres@3.4.7 drizzle-kit@0.31.4

# Standalone output includes required node_modules
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/.next/static ./apps/web/.next/static
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/public ./apps/web/public

# Database migration files
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/src/db/migrations ./apps/web/src/db/migrations
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/drizzle.config.ts ./apps/web/drizzle.config.ts
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/scripts/migrate.ts ./apps/web/scripts/migrate.ts

# Self-hosted init script and its source dependencies
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/scripts/self-hosted-init.ts ./apps/web/scripts/self-hosted-init.ts
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/src/db/schema/scope.ts ./apps/web/src/db/schema/scope.ts
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/src/db/schema/user.ts ./apps/web/src/db/schema/user.ts
COPY --from=builder --chown=nextjs:nodejs /app/apps/web/src/lib/auth/constants.ts ./apps/web/src/lib/auth/constants.ts

# Entrypoint
COPY --chmod=755 docker/entrypoint.sh /entrypoint.sh

# Do not switch to nextjs here; entrypoint.sh handles docker.sock permissions and drops privileges via su-exec

EXPOSE 3000

ENTRYPOINT ["/entrypoint.sh"]
