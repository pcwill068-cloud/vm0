# Code Review: 2280323

## Commit Info

- **Hash**: 2280323
- **Message**: fix: migrate cli events api to read from axiom
- **Files Changed**: 2 (relevant to this PR)

## Summary

This commit fixes a critical bug where the CLI events API (`/api/agent/runs/[id]/events`) was still reading from PostgreSQL while the webhook was writing to Axiom. This caused the CLI to show no events during runs.

## Problem

After the initial migration (75ebade), there was a route mismatch:

- **Write Path**: Webhook → Axiom ✅
- **Read Path (CLI)**: Events API → PostgreSQL ❌

The CLI uses `/api/agent/runs/[id]/events` to poll for new events, which was still querying the empty PostgreSQL table.

## Changes Analysis

### 1. Events Route (`apps/web/app/api/agent/runs/[id]/events/route.ts`)

**Change**: Replaced PostgreSQL query with Axiom APL query

```typescript
// New imports
import {
  queryAxiom,
  getDatasetName,
  DATASETS,
} from "../../../../../../src/lib/axiom";

// New interface for Axiom response
interface AxiomAgentEvent {
  _time: string;
  runId: string;
  userId: string;
  sequenceNumber: number;
  eventType: string;
  eventData: Record<string, unknown>;
}

// APL query
const apl = `['${dataset}']
| where runId == "${params.id}"
| where sequenceNumber > ${since}
| order by sequenceNumber asc
| limit ${limit}`;

const axiomEvents = await queryAxiom<AxiomAgentEvent>(apl);
const events = axiomEvents ?? [];
```

**Assessment**: ✅ Good

- Same APL query pattern as telemetry route
- Proper handling of null return (Axiom not configured)
- Maintains API response format compatibility

### 2. Test File Updates (`route.test.ts`)

**Change**: Complete rewrite to mock Axiom instead of PostgreSQL

Key changes:

- Added Axiom mock setup
- Created `createAxiomAgentEvent` helper function
- Updated all tests to use Axiom mocks
- Tests now verify APL query parameters (since, limit)
- Added non-null assertions for mock.calls access

**Assessment**: ✅ Good

- Tests now accurately test the Axiom-based implementation
- Good coverage of edge cases (empty results, null from Axiom)
- APL query verification ensures correct query construction

## Issues Found

### Minor: Non-null assertions in test file

The test file uses `mockQueryAxiom.mock.calls[0]![0]` which requires TypeScript non-null assertions. This is acceptable for tests where we control the mock setup.

## Overall Assessment

✅ **Approved** - Critical fix that completes the Axiom migration by updating the CLI read path. The implementation matches the pattern established in the telemetry routes.
